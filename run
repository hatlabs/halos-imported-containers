#!/usr/bin/env bash
#
# usage: ./run command [argument ...]
#
# Commands for halos-imported-containers development and builds.

set -o nounset
set -o pipefail
set -o errexit

# Change directory to project root
PROJECT_ROOT=${0%/*}
if [[ $0 != $PROJECT_ROOT && $PROJECT_ROOT != "" ]]; then
  cd "$PROJECT_ROOT"
fi
readonly PROJECT_ROOT=$(pwd)

################################################################################
# Docker Commands

function debtools {
  #@ Run command in debtools container (Debian packaging)
  docker compose -f docker/docker-compose.debtools.yml run --rm debtools "$@"
}

function build-debtools {
  #@ Build debtools Docker image
  #@ Category: Docker
  echo "ðŸ³ Building debtools Docker image..."
  docker compose -f docker/docker-compose.debtools.yml build debtools
  echo "âœ… Docker image built successfully"
}

function shell {
  #@ Open interactive shell in debtools container
  #@ Category: Docker
  echo "ðŸš Opening shell in debtools container..."
  debtools bash
}

################################################################################
# Build Commands

function build-source {
  #@ Build packages for a specific source in debtools container
  #@ Usage: ./run build-source SOURCE_NAME
  #@ Category: Build
  local source_name="${1:-}"

  if [ -z "$source_name" ]; then
    echo "Error: SOURCE_NAME required"
    echo "Usage: ./run build-source SOURCE_NAME"
    echo "Example: ./run build-source casaos-official"
    exit 1
  fi

  echo "ðŸ—ï¸  Building source: $source_name"
  echo "Installing container-packaging-tools..."

  debtools bash -c "
    set -e
    # Install container-packaging-tools from GitHub
    uv tool install git+https://github.com/hatlabs/container-packaging-tools.git
    export PATH=\"\$HOME/.local/bin:\$PATH\"

    # Run the build
    ./tools/build-source.sh $source_name
  "

  echo "âœ… Build complete"
  echo "ðŸ“¦ Packages in build/ directory:"
  ls -lh build/*.deb 2>/dev/null || echo "No .deb files found"
}

function build-all {
  #@ Build all sources in debtools container
  #@ Category: Build
  echo "ðŸ—ï¸  Building all sources..."

  debtools bash -c "
    set -e
    # Install container-packaging-tools from GitHub
    uv tool install git+https://github.com/hatlabs/container-packaging-tools.git
    export PATH=\"\$HOME/.local/bin:\$PATH\"

    # Run the build
    ./tools/build-all.sh
  "

  echo "âœ… Build complete"
}

################################################################################
# Utility Commands

function clean {
  #@ Clean build artifacts
  #@ Category: Utility
  echo "ðŸ§¹ Cleaning build artifacts..."
  rm -rf build/
  echo "âœ… Cleaned"
}

function help {
  #@ Show this help message
  #@ Category: Utility
  echo "HaLOS Imported Containers - Development Commands"
  echo ""
  echo "Usage: ./run COMMAND [ARGS...]"
  echo ""
  echo "Docker:"
  echo "  build-debtools    Build debtools Docker image"
  echo "  shell             Open interactive shell in container"
  echo ""
  echo "Build:"
  echo "  build-source NAME Build packages for specific source"
  echo "  build-all         Build all sources"
  echo ""
  echo "Utility:"
  echo "  clean             Clean build artifacts"
  echo "  help              Show this help message"
  echo ""
  echo "Examples:"
  echo "  ./run build-debtools                # First-time setup"
  echo "  ./run build-source casaos-official  # Build CasaOS packages"
  echo "  ./run shell                         # Interactive development"
}

################################################################################
# Main

# If no command provided, show help
if [ $# -eq 0 ]; then
  help
  exit 0
fi

# Execute the command
COMMAND=$1
shift

if declare -f "$COMMAND" > /dev/null; then
  "$COMMAND" "$@"
else
  echo "Error: Unknown command '$COMMAND'"
  echo ""
  help
  exit 1
fi

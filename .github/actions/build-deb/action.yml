name: Build Debian Packages
description: Build Debian packages (store + apps) for a specific source

inputs:
  source:
    description: 'Source name to build (e.g., casaos-official)'
    required: true

outputs:
  build-dir:
    description: 'Directory containing built packages'
    value: ${{ steps.build.outputs.build-dir }}
  package-count:
    description: 'Number of packages built'
    value: ${{ steps.build.outputs.package-count }}

runs:
  using: composite
  steps:
    - name: Validate source parameter
      shell: bash
      run: |
        if [ -z "${{ inputs.source }}" ]; then
          echo "::error::Source parameter is required"
          exit 1
        fi

        if [ ! -d "sources/${{ inputs.source }}" ]; then
          echo "::warning::Source directory not found: sources/${{ inputs.source }}"
          echo "::notice::Source will be created in future implementation"
          echo "::notice::Skipping build - no source to build yet"
          echo "source-exists=false" >> $GITHUB_ENV
          # Create empty build directory to satisfy artifact upload
          mkdir -p build
          touch build/.placeholder
          exit 0
        fi

        echo "::notice::Building source: ${{ inputs.source }}"
        echo "source-exists=true" >> $GITHUB_ENV

    - name: Set up Python
      uses: actions/setup-python@v5
      if: env.source-exists == 'true'
      with:
        python-version: '3.11'

    - name: Install uv
      shell: bash
      if: env.source-exists == 'true'
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh

        # Verify installation and add to PATH
        # uv may install to ~/.cargo/bin or ~/.local/bin depending on version
        if [ -f "$HOME/.cargo/bin/uv" ]; then
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          "$HOME/.cargo/bin/uv" --version
        elif [ -f "$HOME/.local/bin/uv" ]; then
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          "$HOME/.local/bin/uv" --version
        else
          echo "::error::uv installation failed - binary not found at expected locations"
          exit 1
        fi

    - name: Cache uv dependencies
      uses: actions/cache@v4
      if: env.source-exists == 'true'
      with:
        path: ~/.cache/uv
        key: uv-${{ runner.os }}-${{ hashFiles('**/pyproject.toml', '**/requirements.txt') }}
        restore-keys: |
          uv-${{ runner.os }}-

    - name: Install container-packaging-tools
      shell: bash
      if: env.source-exists == 'true'
      run: |
        echo "::group::Installing container-packaging-tools"
        uv tool install git+https://github.com/hatlabs/container-packaging-tools.git

        # Add to PATH (uv tools install to ~/.local/bin)
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        export PATH="$HOME/.local/bin:$PATH"

        # Verify installation
        if ! generate-container-packages --version; then
          echo "::error::generate-container-packages installation failed"
          exit 1
        fi
        echo "::endgroup::"

    - name: Install Debian packaging tools
      shell: bash
      if: env.source-exists == 'true'
      run: |
        if [ "$RUNNER_OS" == "Linux" ]; then
          sudo apt-get update
          sudo apt-get install -y build-essential dpkg-dev debhelper
        else
          echo "::warning::Debian tools not available on $RUNNER_OS"
          echo "::warning::Build will use placeholder logic"
        fi

    - name: Install YAML validation tools
      shell: bash
      if: env.source-exists == 'true'
      run: |
        # Install yq for YAML validation (pinned version for reproducibility)
        YQ_VERSION="v4.40.5"
        if [ "$RUNNER_OS" == "Linux" ]; then
          sudo wget -qO /usr/local/bin/yq "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64"
          sudo chmod +x /usr/local/bin/yq
          yq --version
        elif [ "$RUNNER_OS" == "macOS" ]; then
          brew install yq
          yq --version
        fi

    - name: Run build
      id: build
      shell: bash
      if: env.source-exists == 'true'
      run: |
        # Validate build script exists
        if [ ! -x "./tools/build-source.sh" ]; then
          echo "::error::build-source.sh not found or not executable"
          exit 1
        fi

        echo "::group::Building source: ${{ inputs.source }}"

        # Run build script
        ./tools/build-source.sh "${{ inputs.source }}"

        echo "::endgroup::"

        # Set outputs
        echo "build-dir=build" >> $GITHUB_OUTPUT

        # Count packages (with error handling)
        if [ -d "build" ]; then
          package_count=$(find build -name "*.deb" 2>/dev/null | wc -l)
          echo "package-count=$package_count" >> $GITHUB_OUTPUT
          echo "::notice::Built $package_count packages"
        else
          echo "package-count=0" >> $GITHUB_OUTPUT
          echo "::error::Build directory not created"
          exit 1
        fi

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: env.source-exists == 'true'
      with:
        name: packages-${{ inputs.source }}
        path: |
          build/*.deb
          build/*.buildinfo
          build/*.changes
        retention-days: 7
        if-no-files-found: error
